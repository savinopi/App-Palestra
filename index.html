<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymBroc App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/savinopi/App-Palestra/main/square_icon.png">
	<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/savinopi/App-Palestra/main/Icon_png_crop.png">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .body-bg {
            background-image: url('https://raw.githubusercontent.com/savinopi/App-Palestra/main/Background.jpg?raw=true');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        .body-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;                   
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.85); /* Dark overlay */
        }
        .modal-scroll {
            max-height: 90vh; /* Imposta l'altezza massima del modale */
            overflow-y: auto; /* Abilita lo scorrimento verticale */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center p-4 md:p-8 body-bg">

    <div id="loader" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-500"></div>
    </div>

    <div id="app-container" class="container mx-auto w-full max-w-4xl relative z-10">
        <h1 class="text-4xl md:text-5xl font-bold text-center text-emerald-600 mb-2 drop-shadow-lg">GymBroc App</h1>
        <p class="text-center text-lg md:text-xl text-gray-400 mb-8">Traccia i tuoi allenamenti e monitora i progressi</p>
        
        <div id="auth-status" class="text-center text-sm mb-4 text-gray-500"></div>

        <!-- Auth View -->
        <div id="auth-view" class="bg-gray-800 p-6 md:p-8 rounded-2xl shadow-xl transition-all duration-300 transform hover:scale-[1.01] border-t-2 border-red-600/30">
            <h2 class="text-2xl font-semibold mb-2 text-gray-200 text-center">Accedi o Registrati</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-400">Email</label>
                    <input type="email" id="auth-email" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 placeholder:text-gray-500" placeholder="tua@email.it" required>
                </div>
                <div class="relative">
                    <label for="auth-password" class="block text-sm font-medium text-gray-400">Password</label>
                    <input type="password" id="auth-password" class="mt-1 block w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 placeholder:text-gray-500" placeholder="password" required>
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-400 top-5" aria-label="Mostra/Nascondi password">
                        <!-- Eye icon SVG -->
                        <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                        <svg id="eye-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off hidden"><path d="M10.585 10.585a2 2 0 0 0 2.829 2.829"/><path d="M16.681 16.681A7.636 7.636 0 0 1 12 17c-3.6 0-6.6-2-9-5 1.5-1.9 4-3.2 6.5-3.7l2.288 2.288"/><path d="M2 12s3-7 10-7c.767 0 1.523.115 2.25.336"/><path d="M16 17a6.613 6.613 0 0 0 4-5c-1.5-1.9-4-3.2-6.5-3.7"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                    </button>
                </div>
                <button type="submit" id="auth-login-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                    Accedi
                </button>
                <p class="text-center text-gray-400">oppure</p>
                <button type="button" id="auth-register-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                    Registrati
                </button>
            </form>
            <div class="mt-6 border-t border-gray-700 pt-6">
                 <p class="text-center text-gray-400 mb-4">Non vuoi registrarti?</p>
                 <button type="button" id="auth-anon-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                    Prova l'app senza registrazione
                </button>
            </div>
        </div>

        <!-- Home View -->
        <div id="home-view" class="hidden bg-gray-800 p-6 md:p-8 rounded-2xl shadow-xl transition-all duration-300 transform hover:scale-[1.01] border-t-2 border-red-600/30">
            <div class="flex justify-center mb-4">
                <img src="https://raw.githubusercontent.com/savinopi/App-Palestra/main/Icon_png_crop.png" alt="Icona App" class="h-20 w-20 rounded-full shadow-lg">
            </div>
            <h2 class="text-2xl font-semibold mb-2 text-gray-200 text-center">Benvenuto!</h2>
            <div class="space-y-4">
                <button id="home-start-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-5 w-5"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>
                    Inizia un nuovo allenamento
                </button>
                <button id="home-history-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-5 w-5"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M12 8v4l2 2"/></svg>
                    Visualizza cronologia
                </button>
                <button id="home-records-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95 mt-2 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-5 w-5"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M8 21v-1a2 2 0 0 0-2-2H4"/><path d="M16 21v-1a2 2 0 0 1 2-2h2"/><path d="M12 5.17A2.5 2.5 0 0 0 9.5 3h-3A2.5 2.5 0 0 0 4 5.5V10c0 2.21 1.79 4 4 4h8c2.21 0 4-1.79 4-4V5.5A2.5 2.5 0 0 0 17.5 3h-3A2.5 2.5 0 0 0 12 5.17Z"/></svg>
                    Record Personali
                </button>
                <button id="home-logout-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-5 w-5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    Logout
                </button>
            </div>
        </div>

        <!-- Workout View -->
        <div id="workout-view" class="hidden bg-gray-800 p-6 md:p-8 rounded-2xl shadow-xl border-t-2 border-red-600/30">
            <button id="workout-back-btn" class="mb-6 text-gray-400 hover:text-gray-200 transition-colors">&larr; Torna alla Home</button>
            <div id="session-summary" class="mb-6 border-b border-gray-700 pb-4">
                <h2 class="text-2xl font-semibold text-gray-200">Sessione attuale</h2>
                <p id="session-info" class="text-sm text-gray-400 mt-2"></p>
            </div>
            
            <!-- Timer per il riposo -->
            <div id="rest-timer-container" class="my-6 p-4 bg-gray-700/50 rounded-lg shadow-inner text-center border border-gray-600">
                <h3 class="text-lg font-semibold text-gray-200 mb-2">Timer Riposo</h3>
                <div id="timer-display" class="text-5xl font-mono text-green-400 mb-4 tracking-wider">00:00</div>
                <div id="timer-controls" class="flex justify-center space-x-2">
                    <button data-time="60" class="timer-start-btn w-24 py-2 px-4 rounded-xl font-bold text-white transition transform hover:scale-105 active:scale-95 bg-teal-600 hover:bg-teal-700">1:00</button>
                    <button data-time="90" class="timer-start-btn w-24 py-2 px-4 rounded-xl font-bold text-white transition transform hover:scale-105 active:scale-95 bg-teal-600 hover:bg-teal-700">1:30</button>
                    <button data-time="120" class="timer-start-btn w-24 py-2 px-4 rounded-xl font-bold text-white transition transform hover:scale-105 active:scale-95 bg-teal-600 hover:bg-teal-700">2:00</button>
                </div>
                 <button id="timer-stop-btn" class="hidden mt-4 w-full max-w-xs mx-auto py-2 px-4 rounded-xl font-bold text-white transition transform hover:scale-105 active:scale-95 bg-red-600 hover:bg-red-700">Ferma Timer</button>
            </div>

            <div id="exercise-form-container">
                <h3 class="text-xl font-semibold mb-4 text-gray-200">Aggiungi un esercizio</h3>
                <form id="exercise-form" class="space-y-4">
                    <div>
                        <label for="muscleGroup" class="block text-sm font-medium text-gray-400">Gruppo Muscolare</label>
                        <select id="muscleGroup" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 transition-colors" required>
                            <option value="">Seleziona...</option>
                            <option value="Petto">Petto</option>
                            <option value="Schiena">Schiena</option>
                            <option value="Gambe">Gambe</option>
                            <option value="Spalle">Spalle</option>
                            <option value="Braccia">Braccia</option>
                            <option value="Addome">Addome</option>
                            <option value="Cardio">Cardio</option>
                            <option value="Corpo intero">Corpo intero</option>
                        </select>
                    </div>
                    <div>
                        <label for="exerciseSelect" class="block text-sm font-medium text-gray-400">Esercizio</label>
                        <select id="exerciseSelect" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 transition-colors" required>
                            <option value="">Seleziona...</option>
                        </select>
                        <input type="text" id="newExerciseInput" class="hidden mt-2 w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 placeholder:text-gray-500" placeholder="Nuovo esercizio">
                    </div>

                    <div id="sets-container" class="space-y-2 p-4 border border-gray-700 rounded-lg">
                        <h4 class="text-md font-semibold text-gray-200 mb-2">Serie</h4>
                        <div class="flex items-center space-x-2">
                            <input type="number" step="0.5" id="weight" class="w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-100" placeholder="Peso">
                            <input type="number" id="reps" class="w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-100" placeholder="Ripetizioni">
                            <button type="button" id="add-set-btn" class="w-1/3 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-xl shadow-md transition transform hover:scale-105">Aggiungi Serie</button>
                        </div>
                        <ul id="sets-list" class="space-y-2 text-sm text-gray-300"></ul>
                    </div>
                    
                    <div>
                        <label for="volume" class="block text-sm font-medium text-gray-400">Volume Totale (kg)</label>
                        <input type="text" id="volume" readonly class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none text-gray-100">
                    </div>

                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-400">Note (Opzionale)</label>
                        <textarea id="notes" rows="2" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 placeholder:text-gray-500" placeholder="Sentito il petto lavorare bene"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                        Aggiungi Esercizio
                    </button>
                </form>
            </div>

            <!-- Container for added exercises in current workout -->
            <div id="current-workout-exercises-list-container" class="mt-8 hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-200">Esercizi Aggiunti</h3>
                <div id="current-workout-exercises-list" class="space-y-4">
                    <p class="text-center text-gray-400">Nessun esercizio ancora aggiunto.</p>
                </div>
            </div>
        </div>

        <!-- History View -->
        <div id="history-view" class="hidden bg-gray-800 p-6 md:p-8 rounded-2xl shadow-xl border-t-2 border-red-600/30">
            <button id="history-back-btn" class="mb-6 text-gray-400 hover:text-gray-200 transition-colors">&larr; Torna alla Home</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-200">Cronologia Allenamenti</h2>
            <button id="add-past-session-btn" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 mb-6 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-5 w-5"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></svg>
                Aggiungi un allenamento
            </button>
            <div id="session-history" class="space-y-6">
                <!-- La cronologia delle sessioni verrà caricata qui -->
            </div>
            <div id="no-history" class="hidden text-center text-gray-500 mt-4">Nessun allenamento registrato. Inizia ad aggiungerne uno!</div>
        </div>
        
        <!-- Modale per i messaggi -->
        <div id="message-modal" class="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
            <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full border-t-2 border-red-600/30">
                <div class="flex justify-between items-start mb-4">
                    <h3 id="modal-title" class="text-xl font-semibold text-gray-100"></h3>
                    <button id="close-message-modal" class="text-gray-400 hover:text-gray-100 text-3xl leading-none focus:outline-none focus:ring-2 focus:ring-red-500 rounded">&times;</button>
                </div>
                <p id="modal-message" class="text-gray-300"></p>
            </div>
        </div>
        
        <!-- Modale per la conferma di eliminazione -->
        <div id="confirm-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
            <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full border-t-2 border-red-600/30">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-semibold text-gray-100">Conferma Eliminazione</h3>
                    <button id="close-confirm-modal" class="text-gray-400 hover:text-gray-100 text-3xl leading-none focus:outline-none focus:ring-2 focus:ring-red-500 rounded">&times;</button>
                </div>
                <p id="confirm-message" class="text-gray-300 mb-4">Sei sicuro di voler eliminare questo allenamento? Questa azione non può essere annullata.</p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300 transform hover:scale-105 active:scale-95">Conferma</button>
                    <button id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300 transform hover:scale-105 active:scale-95">Annulla</button>
                </div>
            </div>
        </div>

        <!-- Modale per visualizzare gli esercizi di una sessione -->
        <div id="exercises-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
            <div class="modal-scroll bg-gray-800 p-6 rounded-2xl shadow-xl max-w-lg w-full border-t-2 border-red-600/30">
                <div class="flex justify-between items-start mb-4">
                    <h3 id="modal-session-title" class="text-xl font-semibold text-gray-100">Dettagli Sessione</h3>
                    <button id="close-exercises-modal" class="text-gray-400 hover:text-gray-100 text-3xl leading-none focus:outline-none focus:ring-2 focus:ring-red-500 rounded">&times;</button>
                </div>
                <div id="exercises-content">
                    <button id="delete-session-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl shadow-md mb-4 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                        Elimina Allenamento
                    </button>
                    <button id="add-exercise-to-past-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl shadow-md mb-4 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                        Aggiungi Esercizio
                    </button>
                    <div id="exercises-list" class="space-y-4">
                        <!-- Gli esercizi verranno caricati qui -->
                    </div>
                    <div id="add-exercise-to-past-form-container" class="hidden mt-4">
                        <button id="back-to-exercises-btn" class="mb-4 text-gray-400 hover:text-gray-200 transition-colors">&larr; Torna agli esercizi</button>
                        <h4 class="text-lg font-semibold mb-4 text-gray-200">Aggiungi un nuovo esercizio</h4>
                        <form id="add-exercise-to-past-form" class="space-y-4">
                            <input type="hidden" id="past-session-id">
                            <div>
                                <label for="past-muscleGroup" class="block text-sm font-medium text-gray-400">Gruppo Muscolare</label>
                                <select id="past-muscleGroup" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100" required>
                                    <option value="">Seleziona...</option>
                                    <option value="Petto">Petto</option>
                                    <option value="Schiena">Schiena</option>
                                    <option value="Gambe">Gambe</option>
                                    <option value="Spalle">Spalle</option>
                                    <option value="Braccia">Braccia</option>
                                    <option value="Addome">Addome</option>
                                    <option value="Cardio">Cardio</option>
                                    <option value="Corpo intero">Corpo intero</option>
                        </select>
                            </div>
                            <div>
                                <label for="past-exerciseSelect" class="block text-sm font-medium text-gray-400">Esercizio</label>
                                <select id="past-exerciseSelect" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100" required>
                                    <option value="">Seleziona...</option>
                                </select>
                                <input type="text" id="past-newExerciseInput" class="hidden mt-2 w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 placeholder:text-gray-500" placeholder="Nuovo esercizio">
                            </div>
                             <div id="past-sets-container" class="space-y-2 p-4 border border-gray-700 rounded-lg">
                                <h4 class="text-md font-semibold text-gray-200 mb-2">Serie</h4>
                                <div class="flex items-center space-x-2">
                                    <input type="number" step="0.5" id="past-weight" class="w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-100" placeholder="Peso">
                                    <input type="number" id="past-reps" class="w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-100" placeholder="Ripetizioni">
                                    <button type="button" id="past-add-set-btn" class="w-1/3 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-xl shadow-md transition transform hover:scale-105">Aggiungi Serie</button>
                                </div>
                                <ul id="past-sets-list" class="space-y-2 text-sm text-gray-300"></ul>
                            </div>
                            
                            <div class="mt-4">
                                <label for="past-volume" class="block text-sm font-medium text-gray-400">Volume di Allenamento (kg)</label>
                                <input type="text" id="past-volume" readonly class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none text-gray-100">
                            </div>
                            <div>
                                <label for="past-notes" class="block text-sm font-medium text-gray-400">Note (Opzionale)</label>
                                <textarea id="past-notes" rows="2" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 placeholder:text-gray-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                                Aggiungi Esercizio a questa Sessione
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modale per la modifica di un esercizio -->
        <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
            <div class="modal-scroll bg-gray-800 p-6 rounded-2xl shadow-xl max-w-lg w-full border-t-2 border-red-600/30">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-semibold text-gray-100">Modifica Esercizio</h3>
                    <button id="close-edit-modal" class="text-gray-400 hover:text-gray-100 text-3xl leading-none focus:outline-none focus:ring-2 focus:ring-red-500 rounded">&times;</button>
                </div>
                <form id="edit-workout-form" class="space-y-4">
                    <input type="hidden" id="edit-session-id">
                    <input type="hidden" id="edit-exercise-id">
                    <div>
                        <label for="edit-exercise" class="block text-sm font-medium text-gray-400">Esercizio</label>
                        <input type="text" id="edit-exercise" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 placeholder:text-gray-500" required>
                    </div>

                    <div id="edit-sets-container" class="space-y-2 p-4 border border-gray-700 rounded-lg">
                        <h4 class="text-md font-semibold text-gray-200 mb-2">Serie</h4>
                        <div class="flex items-center space-x-2">
                            <input type="number" step="0.5" id="edit-weight" class="w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-100" placeholder="Peso">
                            <input type="number" id="edit-reps" class="w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-100" placeholder="Ripetizioni">
                            <button type="button" id="edit-add-set-btn" class="w-1/3 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-xl shadow-md transition transform hover:scale-105">Aggiungi Serie</button>
                        </div>
                        <ul id="edit-sets-list" class="space-y-2 text-sm text-gray-300"></ul>
                    </div>

                    <div>
                        <label for="edit-volume" class="block text-sm font-medium text-gray-400">Volume Totale (kg)</label>
                        <input type="text" id="edit-volume" readonly class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none text-gray-100">
                    </div>

                    <div>
                        <label for="edit-muscleGroup" class="block text-sm font-medium text-gray-400">Gruppo Muscolare</label>
                        <select id="edit-muscleGroup" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 transition-colors" required>
                            <option value="">Seleziona...</option>
                            <option value="Petto">Petto</option>
                            <option value="Schiena">Schiena</option>
                            <option value="Gambe">Gambe</option>
                            <option value="Spalle">Spalle</option>
                            <option value="Braccia">Braccia</option>
                            <option value="Addome">Addome</option>
                            <option value="Cardio">Cardio</option>
                            <option value="Corpo intero">Corpo intero</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-notes" class="block text-sm font-medium text-gray-400">Note (Opzionale)</label>
                        <textarea id="edit-notes" rows="2" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 placeholder:text-gray-500"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                        Salva Modifiche
                    </button>
                </form>
            </div>
        </div>

        <!-- New Past Workout View -->
        <div id="new-past-workout-view" class="hidden bg-gray-800 p-6 md:p-8 rounded-2xl shadow-xl border-t-2 border-green-600/30">
            <button id="new-past-workout-back-btn" class="mb-6 text-gray-400 hover:text-gray-200 transition-colors">&larr; Torna alla Cronologia</button>
            
            <div id="new-past-session-summary" class="mb-6 border-b border-gray-700 pb-4">
                <h2 class="text-2xl font-semibold text-gray-200">Nuovo Allenamento</h2>
                <div class="mt-4">
                    <label for="new-past-workout-datetime" class="block text-sm font-medium text-gray-400">Data e Ora dell'allenamento</label>
                    <input type="datetime-local" id="new-past-workout-datetime" class="mt-1 block w-full max-w-sm px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 text-gray-100" required>
                </div>
                <p id="new-past-session-info" class="text-sm text-gray-400 mt-2"></p>
            </div>
            
            <div id="new-past-exercise-form-container">
                <h3 class="text-xl font-semibold mb-4 text-gray-200">Aggiungi un esercizio</h3>
                <form id="new-past-exercise-form" class="space-y-4">
                    <div>
                        <label for="new-past-muscleGroup" class="block text-sm font-medium text-gray-400">Gruppo Muscolare</label>
                        <select id="new-past-muscleGroup" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 transition-colors" required>
                            <option value="">Seleziona...</option>
                            <option value="Petto">Petto</option>
                            <option value="Schiena">Schiena</option>
                            <option value="Gambe">Gambe</option>
                            <option value="Spalle">Spalle</option>
                            <option value="Braccia">Braccia</option>
                            <option value="Addome">Addome</option>
                            <option value="Cardio">Cardio</option>
                            <option value="Corpo intero">Corpo intero</option>
                        </select>
                    </div>
                    <div>
                        <label for="new-past-exerciseSelect" class="block text-sm font-medium text-gray-400">Esercizio</label>
                        <select id="new-past-exerciseSelect" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 transition-colors" required>
                            <option value="">Seleziona...</option>
                        </select>
                        <input type="text" id="new-past-newExerciseInput" class="hidden mt-2 w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 placeholder:text-gray-500" placeholder="Nuovo esercizio">
                    </div>

                    <div id="new-past-sets-container" class="space-y-2 p-4 border border-gray-700 rounded-lg">
                        <h4 class="text-md font-semibold text-gray-200 mb-2">Serie</h4>
                        <div class="flex items-center space-x-2">
                            <input type="number" step="0.5" id="new-past-weight" class="w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-100" placeholder="Peso">
                            <input type="number" id="new-past-reps" class="w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-100" placeholder="Ripetizioni">
                            <button type="button" id="new-past-add-set-btn" class="w-1/3 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-xl shadow-md transition transform hover:scale-105">Aggiungi Serie</button>
                        </div>
                        <ul id="new-past-sets-list" class="space-y-2 text-sm text-gray-300"></ul>
                    </div>
                    
                    <div>
                        <label for="new-past-volume" class="block text-sm font-medium text-gray-400">Volume Totale (kg)</label>
                        <input type="text" id="new-past-volume" readonly class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none text-gray-100">
                    </div>

                    <div>
                        <label for="new-past-notes" class="block text-sm font-medium text-gray-400">Note (Opzionale)</label>
                        <textarea id="new-past-notes" rows="2" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-100 placeholder:text-gray-500"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                        Aggiungi Esercizio
                    </button>
                </form>
            </div>

            <!-- Container for added exercises -->
            <div id="new-past-exercises-list-container" class="mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-200">Esercizi Aggiunti</h3>
                <div id="new-past-exercises-list" class="space-y-4">
                    <p class="text-center text-gray-400">Nessun esercizio ancora aggiunto.</p>
                </div>
            </div>
        </div>

        <!-- Nuova sezione Record Personali -->
        <div id="records-view" class="hidden bg-gray-800 p-6 md:p-8 rounded-2xl shadow-xl border-t-2 border-yellow-500/30">
            <button id="records-back-btn" class="mb-6 text-gray-400 hover:text-gray-200 transition-colors">&larr; Torna alla Home</button>
            <h2 class="text-2xl font-semibold mb-4 text-yellow-400 text-center">Record Personali</h2>
            
            <!-- Vista di scelta -->
            <div id="records-choice-view">
                <p class="text-center text-gray-400 mb-6">Scegli la categoria di record che vuoi visualizzare.</p>
                <div class="space-y-4">
                    <button id="records-max-weight-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                        Massimale per singola serie
                    </button>
                    <button id="records-total-volume-exercise-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                        Volume Totale per Esercizio
                    </button>
                    <button id="records-total-volume-muscle-group-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-gray-900 active:scale-95">
                        Volume Totale per Gruppo Muscolare
                    </button>
                </div>
            </div>

            <!-- Vista di visualizzazione dei record -->
            <div id="records-display-view" class="hidden">
                <button id="records-display-back-btn" class="mb-4 text-gray-400 hover:text-gray-200 transition-colors">&larr; Torna alla scelta</button>
                <h3 id="records-display-title" class="text-xl font-semibold mb-4 text-yellow-400 text-center"></h3>
                <div id="records-list" class="space-y-6"></div>
                <div id="no-records" class="hidden text-center text-gray-500 mt-4">Nessun record trovato.</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, where, orderBy, limit, serverTimestamp, setDoc, doc, deleteDoc, updateDoc, getDoc, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        const loader = document.getElementById('loader');
        const showLoader = () => loader.classList.remove('hidden');
        const hideLoader = () => loader.classList.add('hidden');

        // --- DOM Element Selections ---
        const authViewEl = document.getElementById('auth-view');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const eyeIcon = document.getElementById('eye-icon');
        const eyeOffIcon = document.getElementById('eye-off-icon');
        const authLoginBtn = document.getElementById('auth-login-btn');
        const authRegisterBtn = document.getElementById('auth-register-btn');
        const authAnonBtn = document.getElementById('auth-anon-btn');
        const homeLogoutBtn = document.getElementById('home-logout-btn');
        const authStatusEl = document.getElementById('auth-status');
        
        const homeViewEl = document.getElementById('home-view');
        const homeStartBtn = document.getElementById('home-start-btn');
        const homeHistoryBtn = document.getElementById('home-history-btn');
        const homeRecordsBtn = document.getElementById('home-records-btn');
    
        const workoutViewEl = document.getElementById('workout-view');
        const workoutBackBtn = document.getElementById('workout-back-btn');
        const sessionInfoEl = document.getElementById('session-info');
        const exerciseForm = document.getElementById('exercise-form');
        const timerDisplay = document.getElementById('timer-display');
        const timerControls = document.getElementById('timer-controls');
        const timerStopBtn = document.getElementById('timer-stop-btn');
        const currentWorkoutExercisesListContainer = document.getElementById('current-workout-exercises-list-container');
        const currentWorkoutExercisesList = document.getElementById('current-workout-exercises-list');
        
        const historyViewEl = document.getElementById('history-view');
        const historyBackBtn = document.getElementById('history-back-btn');
        const sessionHistoryEl = document.getElementById('session-history');
        const noHistoryEl = document.getElementById('no-history');
        
        const recordsViewEl = document.getElementById('records-view');
        const recordsBackBtn = document.getElementById('records-back-btn');
        const recordsChoiceView = document.getElementById('records-choice-view');
        const recordsDisplayView = document.getElementById('records-display-view');
        const recordsDisplayBackBtn = document.getElementById('records-display-back-btn');
        const recordsDisplayTitle = document.getElementById('records-display-title');
        const recordsMaxWeightBtn = document.getElementById('records-max-weight-btn');
        const recordsTotalVolumeExerciseBtn = document.getElementById('records-total-volume-exercise-btn');
        const recordsTotalVolumeMuscleGroupBtn = document.getElementById('records-total-volume-muscle-group-btn');
        const recordsListEl = document.getElementById('records-list');
        const noRecordsEl = document.getElementById('no-records');

        const newPastWorkoutView = document.getElementById('new-past-workout-view');
        const addPastSessionBtn = document.getElementById('add-past-session-btn');
        const newPastWorkoutBackBtn = document.getElementById('new-past-workout-back-btn');
        const newPastWorkoutDatetime = document.getElementById('new-past-workout-datetime');
        const newPastSessionInfo = document.getElementById('new-past-session-info');
        const newPastExerciseForm = document.getElementById('new-past-exercise-form');
        const newPastMuscleGroup = document.getElementById('new-past-muscleGroup');
        const newPastExerciseSelect = document.getElementById('new-past-exerciseSelect');
        const newPastNewExerciseInput = document.getElementById('new-past-newExerciseInput');
        const newPastWeightInput = document.getElementById('new-past-weight');
        const newPastRepsInput = document.getElementById('new-past-reps');
        const newPastAddSetBtn = document.getElementById('new-past-add-set-btn');
        const newPastSetsList = document.getElementById('new-past-sets-list');
        const newPastVolumeInput = document.getElementById('new-past-volume');
        const newPastNotesInput = document.getElementById('new-past-notes');

        const messageModal = document.getElementById('message-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalMessageEl = document.getElementById('modal-message');
        const closeMessageModalBtn = document.getElementById('close-message-modal');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessageEl = document.getElementById('confirm-message');
        const confirmTitleEl = confirmModal.querySelector('h3');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const closeConfirmModalBtn = document.getElementById('close-confirm-modal');

        const exercisesModal = document.getElementById('exercises-modal');
        const modalSessionTitleEl = document.getElementById('modal-session-title');
        const exercisesListEl = document.getElementById('exercises-list');
        const closeExercisesModalBtn = document.getElementById('close-exercises-modal');
        const addExerciseToPastBtn = document.getElementById('add-exercise-to-past-btn');
        const deleteSessionBtn = document.getElementById('delete-session-btn');
        const addExerciseToPastFormContainer = document.getElementById('add-exercise-to-past-form-container');
        const backToExercisesBtn = document.getElementById('back-to-exercises-btn');
        const addExerciseToPastForm = document.getElementById('add-exercise-to-past-form');
        const pastSessionIdInput = document.getElementById('past-session-id');
        const pastExerciseSelect = document.getElementById('past-exerciseSelect');
        const pastNewExerciseInput = document.getElementById('past-newExerciseInput');
        const pastMuscleGroupInput = document.getElementById('past-muscleGroup');
        const pastNotesInput = document.getElementById('past-notes');
        const pastVolumeInput = document.getElementById('past-volume');
        const pastAddSetBtn = document.getElementById('past-add-set-btn');
        const pastWeightInput = document.getElementById('past-weight');
        const pastRepsInput = document.getElementById('past-reps');
        const pastSetsList = document.getElementById('past-sets-list');

        const editModal = document.getElementById('edit-modal');
        const editWorkoutForm = document.getElementById('edit-workout-form');
        const closeEditModalBtn = document.getElementById('close-edit-modal');
        const editSessionIdInput = document.getElementById('edit-session-id');
        const editExerciseIdInput = document.getElementById('edit-exercise-id');
        const editExerciseInput = document.getElementById('edit-exercise');
        const editMuscleGroupInput = document.getElementById('edit-muscleGroup');
        const editNotesInput = document.getElementById('edit-notes');
        const editVolumeInput = document.getElementById('edit-volume');
        const editAddSetBtn = document.getElementById('edit-add-set-btn');
        const editWeightInput = document.getElementById('edit-weight');
        const editRepsInput = document.getElementById('edit-reps');
        const editSetsList = document.getElementById('edit-sets-list');

        const muscleGroupSelect = document.getElementById('muscleGroup');
        const exerciseSelect = document.getElementById('exerciseSelect');
        const newExerciseInput = document.getElementById('newExerciseInput');
        const notesInput = document.getElementById('notes');
        const volumeInput = document.getElementById('volume');
        const addSetBtn = document.getElementById('add-set-btn');
        const weightInput = document.getElementById('weight');
        const repsInput = document.getElementById('reps');
        const setsList = document.getElementById('sets-list');

        const muscleGroups = ["Petto", "Schiena", "Gambe", "Spalle", "Braccia", "Addome", "Cardio", "Corpo intero"];

        // --- App State ---
        let db, auth;
        let userId;
        let currentSessionId = null;
        let recentExercises = {};
        let historyUnsubscribe = null;
        let pendingWorkout = null;
        let currentSets = [];
        let pastSets = [];
        let editSets = [];
        let newPastSets = [];
        let newPastSessionId = null;
        let confirmAction = null;
        let restTimerInterval = null;
        let restTimeRemaining = 0;
        let originalTitle = document.title;
        const timerAlarm = new Audio('https://raw.githubusercontent.com/savinopi/App-Palestra/main/alarm.mp3');

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAuZfMVOWJSV4og8CrvsGb8cKskzW3kfV8",
            authDomain: "gym-tracker-5ff1d.firebaseapp.com",
            projectId: "gym-tracker-5ff1d",
            storageBucket: "gym-tracker-5ff1d.firebasestorage.app",
            messagingSenderId: "249842399106",
            appId: "1:249842399106:web:be361fc20cec812e89c19b",
            measurementId: "G-YXFTKCB77D"
        };
		
        // --- Core Functions ---
        const showView = (viewId) => {
            const views = [homeViewEl, workoutViewEl, historyViewEl, authViewEl, recordsViewEl, newPastWorkoutView];
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        };

        const showMessage = (title, message) => {
            modalTitleEl.textContent = title;
            modalMessageEl.textContent = message;
            messageModal.classList.remove('hidden');
            modalMessageEl.classList.remove('hidden');
            messageModal.classList.add('flex');
        };

        closeMessageModalBtn.addEventListener('click', () => {
            messageModal.classList.remove('flex');
            messageModal.classList.add('hidden');
        });

        const showConfirmationModal = (title, message, confirmText, onConfirm) => {
            confirmTitleEl.textContent = title;
            confirmMessageEl.textContent = message;
            confirmDeleteBtn.textContent = confirmText;
            confirmAction = onConfirm;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
        };

        const hideConfirmModal = () => {
            confirmModal.classList.remove('flex');
            confirmModal.classList.add('hidden');
            confirmAction = null;
        };

        const updateVolumePreview = (sets, volumeEl) => {
            const totalVolume = sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
            volumeEl.value = totalVolume.toLocaleString('it-IT');
        };

        const sessionsCollectionPath = (uid) => `users/${uid}/sessions`;
        const exercisesCollectionPath = (uid, sessionId) => `users/${uid}/sessions/${sessionId}/exercises`;

        const updateSessionMuscleGroupsInTransaction = async (sessionId) => {
            if (!sessionId || !userId) return;
            
            await runTransaction(db, async (transaction) => {
                const sessionRef = doc(db, sessionsCollectionPath(userId), sessionId);
                const exercisesSnapshot = await getDocs(query(collection(db, exercisesCollectionPath(userId, sessionId))));
                
                const muscleGroups = new Set();
                exercisesSnapshot.forEach(exerciseDoc => {
                    const muscleGroup = exerciseDoc.data().muscleGroup;
                    if (muscleGroup) {
                        muscleGroups.add(muscleGroup);
                    }
                });
                
                const sessionDoc = await transaction.get(sessionRef);
                if (sessionDoc.exists()) {
                    transaction.update(sessionRef, { muscleGroups: Array.from(muscleGroups) });
                }
            });
        };

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                console.error("Errore nell'inizializzazione di Firebase:", error);
                showMessage("Errore", "Impossibile connettersi a Firebase. Controlla la console per i dettagli.");
            }
        } else {
            console.error("Configurazione Firebase non trovata.");
            showMessage("Errore", "Configurazione Firebase mancante. Vai su Firebase Console per ottenerla.");
        }

        // Definisci handleAuthState PRIMA!
        const handleAuthState = async (user) => {
            if (user) {
                userId = user.uid;
                if (user.isAnonymous) {
                    authStatusEl.textContent = `Modalità di prova: i dati non sono permanenti. Registrati per salvarli.`;
                    homeRecordsBtn.classList.add('hidden');
                } else {
                    const username = user.email.split('@')[0];
                    authStatusEl.textContent = `Ciao ${username}`;
                    homeRecordsBtn.classList.remove('hidden');
                }
                await fetchRecentExercises(); 
                showView('home-view');
            } else {
                if (historyUnsubscribe) {
                    historyUnsubscribe();
                    historyUnsubscribe = null;
                }
                userId = null;
                showView('auth-view');
                authStatusEl.textContent = '';
            }
            hideLoader();
        };

        // Carica i record solo per utenti autenticati (non anonimi)

        const getAllExercisesFromHistory = async () => {
            if (!userId) return [];
            let allExercises = [];
            const sessionsQuery = query(collection(db, sessionsCollectionPath(userId)), orderBy('timestamp', 'desc'));
            const sessionsSnapshot = await getDocs(sessionsQuery);

            for (const sessionDoc of sessionsSnapshot.docs) {
                const sessionDate = new Date(sessionDoc.data().timestamp.seconds * 1000);
                const exercisesQuery = query(collection(db, exercisesCollectionPath(userId, sessionDoc.id)));
                const exercisesSnapshot = await getDocs(exercisesQuery);

                exercisesSnapshot.forEach(doc => {
                    const data = doc.data();
                    allExercises.push({
                        ...data,
                        date: sessionDate.toLocaleDateString('it-IT'),
                    });
                });
            }
            return allExercises;
        };

        const loadTotalVolumeExerciseRecords = async () => {
            showLoader();
            recordsListEl.innerHTML = '';
            noRecordsEl.classList.add('hidden');
            
            try {
                const allExercises = await getAllExercisesFromHistory();
                if (allExercises.length === 0) {
                    noRecordsEl.classList.remove('hidden');
                    return;
                }

                const grouped = {};
                allExercises.forEach(ex => {
                    const muscleGroup = ex.muscleGroup || 'Non specificato';
                    if (!grouped[muscleGroup]) grouped[muscleGroup] = {};
                    if (!grouped[muscleGroup][ex.exercise] || (ex.volume || 0) > (grouped[muscleGroup][ex.exercise].volume || 0)) {
                        grouped[ex.muscleGroup][ex.exercise] = ex;
                    }
                });

                let found = false;
                Object.keys(grouped).sort().forEach(muscleGroup => {
                    const groupDiv = document.createElement('div');
                    groupDiv.classList.add('bg-gray-700', 'p-4', 'rounded-lg', 'shadow-md', 'mb-6');
                    groupDiv.innerHTML = `<h3 class="text-lg font-semibold text-yellow-300 mb-2">${muscleGroup}</h3>`;
                    
                    let hasExercisesInGroup = false;
                    Object.keys(grouped[muscleGroup]).sort().forEach(exName => {
                        const rec = grouped[muscleGroup][exName];
                        found = true;
                        hasExercisesInGroup = true;
                        groupDiv.innerHTML += `
                            <div class="mb-2">
                                <div class="font-semibold text-yellow-200">${exName}</div>
                                <div class="flex justify-between items-center py-1">
                                    <span>${(rec.volume || 0).toLocaleString('it-IT')} kg</span>
                                    <span class="text-gray-400 text-sm">${rec.date}</span>
                                </div>
                                <div class="text-sm text-gray-300 mt-1">
                                    ${rec.sets && rec.sets.length > 0
                                        ? rec.sets.map((set, idx) => `<div>Serie ${idx + 1}: <span class="text-white">${set.weight} kg x ${set.reps} reps</span></div>`).join('')
                                        : '<div>Nessuna serie registrata</div>'
                                    }
                                </div>
                            </div>
                        `;
                    });

                    if (hasExercisesInGroup) {
                        recordsListEl.appendChild(groupDiv);
                    }
                });

                if (!found) {
                    noRecordsEl.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Errore nel caricamento dei record di volume per esercizio:", error);
                recordsListEl.innerHTML = '<p class="text-red-400">Errore nel caricamento dei record.</p>';
            } finally {
                hideLoader();
            }
        };

        const loadMaxWeightRecords = async () => {
            showLoader();
            recordsListEl.innerHTML = '';
            noRecordsEl.classList.add('hidden');

            try {
                const allExercises = await getAllExercisesFromHistory();
                if (allExercises.length === 0) {
                    noRecordsEl.classList.remove('hidden');
                    return;
                }

                const bestSets = {};
                allExercises.forEach(ex => {
                    if (ex.sets && ex.sets.length > 0) {
                        ex.sets.forEach(set => {
                            const weight = set.weight || 0;
                            if (!bestSets[ex.exercise] || weight > bestSets[ex.exercise].weight) {
                                bestSets[ex.exercise] = {
                                    weight: weight,
                                    reps: set.reps,
                                    exercise: ex.exercise,
                                    muscleGroup: ex.muscleGroup || 'Non specificato',
                                    date: ex.date
                                };
                            }
                        });
                    }
                });

                const groupedByMuscle = {};
                Object.values(bestSets).forEach(rec => {
                    if (!groupedByMuscle[rec.muscleGroup]) {
                        groupedByMuscle[rec.muscleGroup] = [];
                    }
                    groupedByMuscle[rec.muscleGroup].push(rec);
                });

                let found = false;
                Object.keys(groupedByMuscle).sort().forEach(muscleGroup => {
                    const groupDiv = document.createElement('div');
                    groupDiv.classList.add('bg-gray-700', 'p-4', 'rounded-lg', 'shadow-md', 'mb-6');
                    groupDiv.innerHTML = `<h3 class="text-lg font-semibold text-yellow-300 mb-2">${muscleGroup}</h3>`;
                    
                    groupedByMuscle[muscleGroup].sort((a, b) => a.exercise.localeCompare(b.exercise)).forEach(rec => {
                        found = true;
                        groupDiv.innerHTML += `
                            <div class="mb-2">
                                <div class="font-semibold text-yellow-200">${rec.exercise}</div>
                                <div class="flex justify-between items-center py-1">
                                    <span><span class="font-bold">${rec.weight} kg</span> x ${rec.reps} reps</span>
                                    <span class="text-gray-400 text-sm">${rec.date}</span>
                                </div>
                            </div>
                        `;
                    });
                    recordsListEl.appendChild(groupDiv);
                });

                if (!found) {
                    noRecordsEl.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Errore nel caricamento dei record di massimale:", error);
                recordsListEl.innerHTML = '<p class="text-red-400">Errore nel caricamento dei record.</p>';
            } finally {
                hideLoader();
            }
        };

        const loadTotalVolumeMuscleGroupRecords = async () => {
            showLoader();
            recordsListEl.innerHTML = '';
            noRecordsEl.classList.add('hidden');

            try {
                const sessionsQuery = query(collection(db, sessionsCollectionPath(userId)), orderBy('timestamp', 'desc'));
                const sessionsSnapshot = await getDocs(sessionsQuery);

                const sessionVolumesByGroup = {};

                for (const sessionDoc of sessionsSnapshot.docs) {
                    const sessionDate = new Date(sessionDoc.data().timestamp.seconds * 1000).toLocaleDateString('it-IT');
                    const exercisesQuery = query(collection(db, exercisesCollectionPath(userId, sessionDoc.id)));
                    const exercisesSnapshot = await getDocs(exercisesQuery);

                    const currentSessionVolumes = {};
                    exercisesSnapshot.forEach(exDoc => {
                        const exData = exDoc.data();
                        const group = exData.muscleGroup || 'Non specificato';
                        const volume = exData.volume || 0;
                        if (!currentSessionVolumes[group]) currentSessionVolumes[group] = 0;
                        currentSessionVolumes[group] += volume;
                    });

                    Object.keys(currentSessionVolumes).forEach(group => {
                        if (!sessionVolumesByGroup[group] || currentSessionVolumes[group] > sessionVolumesByGroup[group].volume) {
                            sessionVolumesByGroup[group] = {
                                volume: currentSessionVolumes[group],
                                date: sessionDate
                            };
                        }
                    });
                }

                let found = false;
                if (Object.keys(sessionVolumesByGroup).length > 0) {
                    const recordsDiv = document.createElement('div');
                    recordsDiv.classList.add('bg-gray-700', 'p-4', 'rounded-lg', 'shadow-md');

                    Object.keys(sessionVolumesByGroup).sort().forEach(group => {
                        found = true;
                        const rec = sessionVolumesByGroup[group];
                        recordsDiv.innerHTML += `
                            <div class="mb-2">
                                <div class="font-semibold text-yellow-200">${group}</div>
                                <div class="flex justify-between items-center py-1">
                                    <span>${rec.volume.toLocaleString('it-IT')} kg</span>
                                    <span class="text-gray-400 text-sm">${rec.date}</span>
                                </div>
                            </div>
                        `;
                    });
                    recordsListEl.appendChild(recordsDiv);
                }

                if (!found) {
                    noRecordsEl.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Errore nel caricamento dei record di volume per gruppo:", error);
                recordsListEl.innerHTML = '<p class="text-red-400">Errore nel caricamento dei record.</p>';
            } finally {
                hideLoader();
            }
        };

        // --- Init & Auth Listeners ---
        if (auth) {
            showLoader();
            onAuthStateChanged(auth, handleAuthState);
        }

        const loadHistory = async () => {
            if (!userId) {
                showMessage("Errore", "Utente non autenticato. Riprova.");
                return;
            }

            showLoader();
            sessionHistoryEl.innerHTML = '';

            if (historyUnsubscribe) {
                historyUnsubscribe();
            }
            
            try {
                const sessionsCollectionRef = collection(db, sessionsCollectionPath(userId));
                const q = query(sessionsCollectionRef, orderBy('timestamp', 'desc'));
                
                historyUnsubscribe = onSnapshot(q, async (querySnapshot) => {
                    const sessionPromises = querySnapshot.docs.map(async (sessionDoc) => {
                        const sessionData = sessionDoc.data();
                        if (!sessionData.timestamp) return null;

                        let muscleGroupsArray = [];

                        // Check if the optimized field exists
                        if (sessionData.muscleGroups) {
                            muscleGroupsArray = sessionData.muscleGroups;
                        } else {
                            // Fallback for old data: fetch exercises and calculate groups
                            const exercisesQuery = query(collection(db, exercisesCollectionPath(userId, sessionDoc.id)));
                            const exercisesSnapshot = await getDocs(exercisesQuery);
                            
                            const muscleGroupsSet = new Set();
                            exercisesSnapshot.forEach(exerciseDoc => {
                                const muscleGroup = exerciseDoc.data().muscleGroup;
                                if (muscleGroup) {
                                    muscleGroupsSet.add(muscleGroup);
                                }
                            });
                            muscleGroupsArray = Array.from(muscleGroupsSet);
                        }

                        return {
                            id: sessionDoc.id,
                            timestamp: sessionData.timestamp,
                            muscleGroups: muscleGroupsArray.sort()
                        };
                    });
                    const sessionsWithDetails = (await Promise.all(sessionPromises)).filter(s => s !== null);
                    sessionHistoryEl.innerHTML = '';
                    
                    if (sessionsWithDetails.length === 0) {
                        noHistoryEl.classList.remove('hidden');
                    } else {
                        noHistoryEl.classList.add('hidden');
                        sessionsWithDetails.forEach(session => {
                            const sessionItem = document.createElement('div');
                            sessionItem.classList.add('bg-gray-700', 'p-4', 'rounded-lg', 'shadow-md', 'cursor-pointer', 'flex', 'flex-col', 'sm:flex-row', 'items-start', 'sm:items-center', 'justify-between', 'space-y-2', 'sm:space-y-0', 'hover:bg-gray-600', 'transition-colors');
                            sessionItem.dataset.id = session.id;
                            const formattedDate = new Date(session.timestamp.seconds * 1000).toLocaleString();
                            
                            const muscleGroupsHtml = session.muscleGroups.length > 0 
                                ? `<div class="flex flex-wrap gap-2 mt-2 sm:mt-0">
                                    ${session.muscleGroups.map(group => `<span class="bg-red-500/50 text-red-200 text-xs font-semibold px-2.5 py-0.5 rounded-full">${group}</span>`).join('')}
                                   </div>`
                                : '';

                            sessionItem.innerHTML = `
                                <div class="flex-grow">
                                    <h3 class="text-lg font-semibold text-gray-100">Allenamento del ${formattedDate}</h3>
                                </div>
                                ${muscleGroupsHtml}
                            `;
                            sessionHistoryEl.appendChild(sessionItem);
                        });
                        document.querySelectorAll('#session-history > div').forEach(item => {
                            item.addEventListener('click', handleSessionClick);
                        });
                    }
                    hideLoader();
                }, (error) => {
                    console.error("Errore nello snapshot della cronologia:", error);
                    showMessage("Errore", "Impossibile aggiornare la cronologia in tempo reale.");
                    hideLoader();
                });

            } catch (error) {
                console.error("Errore nel caricamento della cronologia:", error);
                showMessage("Errore", "Impossibile caricare la cronologia degli allenamenti.");
                hideLoader();
            }
        };

        const fetchRecentExercises = async () => {
            if (!userId) return;
            try {
                recentExercises = {};
                const sessionsQuery = query(collection(db, sessionsCollectionPath(userId)), orderBy('timestamp', 'desc'), limit(10));
                const sessionsSnapshot = await getDocs(sessionsQuery);
                
                for (const sessionDoc of sessionsSnapshot.docs) {
                    const exercisesQuery = query(collection(db, exercisesCollectionPath(userId, sessionDoc.id)), orderBy('timestamp', 'desc'));
                    const exercisesSnapshot = await getDocs(exercisesQuery);
                    
                    exercisesSnapshot.forEach(doc => {
                        const data = doc.data();
                        const group = data.muscleGroup || 'Non specificato';
                        const exerciseName = data.exercise;

                        if (!recentExercises[group]) {
                            recentExercises[group] = {};
                        }

                        if (!recentExercises[group][exerciseName]) {
                            recentExercises[group][exerciseName] = data;
                        }
                    });
                }
            } catch (error) {
                console.error("Errore nel recuperare gli esercizi recenti:", error);
                // Non mostrare un modale qui, è un'attività in background.
                // L'app può continuare a funzionare anche senza gli esercizi recenti.
            }
        };

        const populateExerciseDropdown = (selectEl, inputEl, muscleGroup) => {
            selectEl.innerHTML = '<option value="">Seleziona...</option>';
            inputEl.classList.add('hidden');
            
            const exercisesForGroup = recentExercises[muscleGroup] || {};
            const exerciseNames = Object.keys(exercisesForGroup).sort();

            exerciseNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selectEl.appendChild(option);
            });

            const newOption = document.createElement('option');
            newOption.value = 'new';
            newOption.textContent = 'Nuovo esercizio...';
            selectEl.appendChild(newOption);
        };

        const handleExerciseSelection = (selectEl, inputEl, muscleGroup, weightEl, repsEl, setsListEl, volumeEl, setsArray) => {
            const selectedValue = selectEl.value;
            if (selectedValue === 'new') {
                inputEl.value = '';
                inputEl.classList.remove('hidden');
                weightEl.value = '';
                repsEl.value = '10';
                setsArray.length = 0;
            } else if (selectedValue) {
                inputEl.classList.add('hidden');
                const exerciseData = recentExercises[muscleGroup][selectedValue];
                if (exerciseData) {
                    setsArray.length = 0;
                    if (exerciseData.sets && Array.isArray(exerciseData.sets)) {
                        // Create new plain objects to avoid issues with immutable Firestore data
                        exerciseData.sets.forEach(set => setsArray.push({ weight: set.weight, reps: set.reps }));
                    }
                    if (setsArray.length > 0) {
                        weightEl.value = setsArray[0].weight || '';
                        repsEl.value = setsArray[0].reps || '10';
                    }
                }
            } else {
                 inputEl.classList.add('hidden');
                 setsArray.length = 0;
            }
            renderSetsList(setsArray, setsListEl, weightEl, repsEl, volumeEl);
        };
        
        const renderSetsList = (sets, setsListEl, weightEl, repsEl, volumeEl) => {
            setsListEl.innerHTML = '';
            sets.forEach((set, index) => {
                const li = document.createElement('li');
                li.classList.add('flex', 'justify-between', 'items-center', 'py-1', 'px-2', 'bg-gray-600', 'rounded-md');
                li.innerHTML = `
                    <span>Serie ${index + 1}: <span class="text-white">${set.weight}kg x ${set.reps}</span></span>
                    <button type="button" class="remove-set-btn text-red-400 hover:text-red-300 transition-colors" data-index="${index}">&times;</button>
                `;
                setsListEl.appendChild(li);
            });
            updateVolumePreview(sets, volumeEl);

            setsListEl.querySelectorAll('.remove-set-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    sets.splice(index, 1);
                    renderSetsList(sets, setsListEl, weightEl, repsEl, volumeEl);
                });
            });
        };

        const addSet = (weightEl, repsEl, setsArray, setsListEl, volumeEl) => {
            const weight = parseFloat(weightEl.value);
            const reps = parseInt(repsEl.value, 10);
            if (!isNaN(weight) && !isNaN(reps) && weight > 0 && reps > 0) {
                setsArray.push({ weight, reps });
                renderSetsList(setsArray, setsListEl, weightEl, repsEl, volumeEl);
                weightEl.value = weight;
                repsEl.value = reps;
            } else {
                 showMessage("Attenzione", "Peso e Ripetizioni devono essere numeri validi e maggiori di zero.");
            }
        };

        addSetBtn.addEventListener('click', () => addSet(weightInput, repsInput, currentSets, setsList, volumeInput));
        pastAddSetBtn.addEventListener('click', () => addSet(pastWeightInput, pastRepsInput, pastSets, pastSetsList, pastVolumeInput));
        editAddSetBtn.addEventListener('click', () => addSet(editWeightInput, editRepsInput, editSets, editSetsList, editVolumeInput));
        newPastAddSetBtn.addEventListener('click', () => addSet(newPastWeightInput, newPastRepsInput, newPastSets, newPastSetsList, newPastVolumeInput));

        // --- Timer Functions ---
        const updateTimerDisplay = () => {
            const minutes = Math.floor(restTimeRemaining / 60);
            const seconds = restTimeRemaining % 60;
            const displayString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timerDisplay.textContent = displayString;
            document.title = `${displayString} - ${originalTitle}`;
        };

        const stopTimer = () => {
            clearInterval(restTimerInterval);
            restTimerInterval = null;
            restTimeRemaining = 0;
            updateTimerDisplay(); // Reset display to 00:00
            document.title = originalTitle;
            timerControls.classList.remove('hidden');
            timerStopBtn.classList.add('hidden');
        };

        const startTimer = (seconds) => {
            stopTimer(); // Stop any existing timer first
            restTimeRemaining = seconds;
            updateTimerDisplay();

            timerControls.classList.add('hidden');
            timerStopBtn.classList.remove('hidden');

            restTimerInterval = setInterval(() => {
                restTimeRemaining--;
                updateTimerDisplay();
                if (restTimeRemaining <= 0) {
                    stopTimer();
                    timerAlarm.play();
                    showMessage("Riposo Finito!", "È ora di iniziare la prossima serie!");
                }
            }, 1000);
        };

        document.querySelectorAll('.timer-start-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const time = parseInt(e.currentTarget.dataset.time, 10);
                startTimer(time);
            });
        });

        timerStopBtn.addEventListener('click', stopTimer);

        newPastMuscleGroup.addEventListener('change', (e) => {
            populateExerciseDropdown(newPastExerciseSelect, newPastNewExerciseInput, e.target.value);
            handleExerciseSelection(newPastExerciseSelect, newPastNewExerciseInput, e.target.value, newPastWeightInput, newPastRepsInput, newPastSetsList, newPastVolumeInput, newPastSets);
        });

        newPastExerciseSelect.addEventListener('change', (e) => {
            handleExerciseSelection(newPastExerciseSelect, newPastNewExerciseInput, newPastMuscleGroup.value, newPastWeightInput, newPastRepsInput, newPastSetsList, newPastVolumeInput, newPastSets);
        });

        muscleGroupSelect.addEventListener('change', (e) => {
            populateExerciseDropdown(exerciseSelect, newExerciseInput, e.target.value);
            handleExerciseSelection(exerciseSelect, newExerciseInput, e.target.value, weightInput, repsInput, setsList, volumeInput, currentSets);
        });

        exerciseSelect.addEventListener('change', (e) => {
            handleExerciseSelection(exerciseSelect, newExerciseInput, muscleGroupSelect.value, weightInput, repsInput, setsList, volumeInput, currentSets);
        });

        pastMuscleGroupInput.addEventListener('change', (e) => {
            populateExerciseDropdown(pastExerciseSelect, pastNewExerciseInput, e.target.value);
            handleExerciseSelection(pastExerciseSelect, pastNewExerciseInput, e.target.value, pastWeightInput, pastRepsInput, pastSetsList, pastVolumeInput, pastSets);
        });

        pastExerciseSelect.addEventListener('change', (e) => {
            handleExerciseSelection(pastExerciseSelect, pastNewExerciseInput, pastMuscleGroupInput.value, pastWeightInput, pastRepsInput, pastSetsList, pastVolumeInput, pastSets);
        });

        homeStartBtn.addEventListener('click', () => {
            currentSessionId = null;
            showView('workout-view');
            sessionInfoEl.textContent = `Iniziato: ${new Date().toLocaleString()}`;
            exerciseForm.reset();
            currentSets = [];
            setsList.innerHTML = '';
            volumeInput.value = '';
            currentWorkoutExercisesListContainer.classList.add('hidden');
            currentWorkoutExercisesList.innerHTML = '<p class="text-center text-gray-400">Nessun esercizio ancora aggiunto.</p>';
        });

        workoutBackBtn.addEventListener('click', () => {
            if (currentSessionId) {
                showConfirmationModal(
                    "Conferma Uscita",
                    "La sessione di allenamento è in corso. Se torni indietro, gli esercizi aggiunti non verranno salvati. Sei sicuro di voler uscire?",
                    "Sì, esci",
                    () => {
                        stopTimer();
                        currentSessionId = null;
                        showView('home-view');
                    }
                );
            } else {
                stopTimer();
                showView('home-view');
            }
        });

        newPastWorkoutBackBtn.addEventListener('click', () => {
            // Simply go back to the history view. The onSnapshot listener will have updated it.
            showView('history-view');
        });

        newPastExerciseForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const workoutTimestampStr = newPastWorkoutDatetime.value;
            if (!workoutTimestampStr) {
                showMessage("Errore", "Per favore, specifica la data e l'ora dell'allenamento.");
                return;
            }
            const workoutDate = new Date(workoutTimestampStr);

            let exerciseName = newPastExerciseSelect.value;
            if (exerciseName === 'new') {
                exerciseName = newPastNewExerciseInput.value.trim();
            }
            const muscleGroup = newPastMuscleGroup.value;
            const notes = newPastNotesInput.value.trim();
            const totalVolume = newPastSets.reduce((sum, set) => sum + (set.weight * set.reps), 0);

            if (!exerciseName || !muscleGroup || newPastSets.length === 0) {
                showMessage("Errore", "Compila tutti i campi obbligatori e aggiungi almeno una serie.");
                return;
            }

            const newExercise = { exercise: exerciseName, muscleGroup, sets: newPastSets, volume: totalVolume, notes, timestamp: workoutDate };

            showLoader();
            try {
                if (!newPastSessionId) {
                    const newSessionRef = await addDoc(collection(db, sessionsCollectionPath(userId)), { timestamp: workoutDate });
                    newPastSessionId = newSessionRef.id;
                    newPastSessionInfo.textContent = `Aggiungendo esercizi all'allenamento del: ${workoutDate.toLocaleString()}`;
                    newPastWorkoutDatetime.disabled = true;
                }

                await addDoc(collection(db, exercisesCollectionPath(userId, newPastSessionId)), newExercise);
                await updateSessionMuscleGroupsInTransaction(newPastSessionId);
                
                // Reset form for the next exercise
                newPastExerciseForm.reset();
                newPastSets = [];
                newPastSetsList.innerHTML = '';
                newPastVolumeInput.value = '';
                
                // Refresh the list of added exercises on the page
                await renderExercisesForSession(newPastSessionId, document.getElementById('new-past-exercises-list'));
                
                fetchRecentExercises(); // Fire and forget, it's a background task
                showMessage("Successo", "Esercizio aggiunto con successo all'allenamento!");

            } catch (error) {
                console.error("Errore nell'aggiungere l'esercizio passato:", error);
                showMessage("Errore", "Si è verificato un errore durante il salvataggio dell'esercizio.");
            } finally {
                hideLoader();
            }
        });


      exerciseForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    let exerciseName = exerciseSelect.value;
    if (exerciseName === 'new') {
        exerciseName = newExerciseInput.value.trim();
    }
    const muscleGroup = muscleGroupSelect.value;
    const notes = notesInput.value.trim();
    const totalVolume = currentSets.reduce((sum, set) => sum + (set.weight * set.reps), 0);

    // PATCH: log di debug!
    console.log("[submit] currentSets:", currentSets);
    console.log("[submit] newExercise:", {
        exercise: exerciseName,
        muscleGroup,
        sets: currentSets,
        volume: totalVolume,
        notes
    });

    if (!exerciseName || !muscleGroup || currentSets.length === 0) {
        showMessage("Errore", "Per favor, compila tutti i campi obbligatori e aggiungi almeno una serie.");
        return;
    }

    const newExercise = {
        exercise: exerciseName,
        muscleGroup,
        sets: currentSets,
        volume: totalVolume,
        notes,
        timestamp: serverTimestamp(),
    };

    showLoader();
    try {
        if (!currentSessionId) {
            const newSessionRef = await addDoc(collection(db, sessionsCollectionPath(userId)), {
                timestamp: serverTimestamp(),
            });
            currentSessionId = newSessionRef.id;
            currentWorkoutExercisesListContainer.classList.remove('hidden');
        }

        await addDoc(collection(db, exercisesCollectionPath(userId, currentSessionId)), newExercise);
        await updateSessionMuscleGroupsInTransaction(currentSessionId);

        await renderExercisesForSession(currentSessionId, currentWorkoutExercisesList);

        // PATCH: reset solo i campi utili!
        newExerciseInput.value = '';
        notesInput.value = '';
        weightInput.value = '';
        repsInput.value = '';
        volumeInput.value = '';
        currentSets = [];
        setsList.innerHTML = '';

        await fetchRecentExercises();
        showMessage("Successo", "Esercizio aggiunto con successo!");
    } catch (error) {
        console.error("Errore nell'aggiungere l'esercizio:", error);
        showMessage("Errore", "Si è verificato un errore durante il salvataggio dell'esercizio.");
    } finally {
        hideLoader();
    }
                });

        const renderExercisesForSession = async (sessionId, containerEl, options = {}) => {
            const { showEditDelete = false } = options;

            if (!sessionId) {
                containerEl.innerHTML = '<p class="text-center text-gray-400">Nessun esercizio ancora aggiunto.</p>';
                return;
            }

            containerEl.innerHTML = ''; // Clear previous content

            try {
                const exercisesQuery = query(collection(db, exercisesCollectionPath(userId, sessionId)), orderBy('timestamp', 'asc'));
                const querySnapshot = await getDocs(exercisesQuery);
                
                const exercises = [];
                querySnapshot.forEach(doc => {
                    exercises.push({ id: doc.id, ...doc.data() });
                });

                if (exercises.length === 0) {
                    containerEl.innerHTML = '<p class="text-center text-gray-400">Nessun esercizio registrato per questa sessione.</p>';
                } else {
                    const groupedExercises = exercises.reduce((acc, current) => {
                        const group = current.muscleGroup || 'Non specificato';
                        if (!acc[group]) acc[group] = [];
                        acc[group].push(current);
                        return acc;
                    }, {});

                    for (const group of muscleGroups) {
                        if (groupedExercises[group]) {
                            const groupTitle = document.createElement('h4');
                            groupTitle.classList.add('text-lg', 'font-semibold', 'text-gray-200', 'mt-4');
                            groupTitle.textContent = group;
                            containerEl.appendChild(groupTitle);

                            groupedExercises[group].forEach(exercise => {
                                const exerciseItem = document.createElement('div');
                                exerciseItem.classList.add('bg-gray-700', 'p-4', 'rounded-lg', 'shadow-md');
                                
                                let setsHtml = exercise.sets && Array.isArray(exercise.sets)
                                    ? exercise.sets.map((set, index) => `<p class="text-sm text-gray-300 ml-4">Serie ${index + 1}: <span class="text-white">${set.weight}kg x ${set.reps}</span></p>`).join('')
                                    : '';

                                const buttonsHtml = showEditDelete ? `
                                    <div class="flex space-x-2 mt-2 sm:mt-0">
                                        <button class="edit-btn text-blue-400 hover:text-blue-300 text-sm font-medium" data-session-id="${sessionId}" data-exercise-id="${exercise.id}">Modifica</button>
                                        <button class="delete-btn text-red-400 hover:text-red-300 text-sm font-medium" data-session-id="${sessionId}" data-exercise-id="${exercise.id}">Elimina</button>
                                    </div>` : '';

                                exerciseItem.innerHTML = `
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-2 sm:space-y-0">
                                        <div>
                                            <h5 class="font-semibold text-gray-100">${exercise.exercise}</h5>
                                            ${setsHtml}
                                            <p class="text-sm text-gray-300 mt-2">Volume Totale: <span class="text-white">${(exercise.volume || 0).toLocaleString('it-IT')} kg</span></p>
                                            ${exercise.notes ? `<p class="text-sm italic text-gray-400 mt-1">Note: ${exercise.notes}</p>` : ''}
                                        </div>
                                        ${buttonsHtml}
                                    </div>`;
                                containerEl.appendChild(exerciseItem);
                            });
                        }
                    }
                    
                    if (showEditDelete) {
                        containerEl.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
                        containerEl.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
                    }
                }
            } catch (error) {
                console.error("Errore nel caricamento degli esercizi:", error);
                containerEl.innerHTML = '<p class="text-red-400">Impossibile caricare gli esercizi.</p>';
            }
        };

        const handleSessionClick = async (e) => {
            let sessionId = e.currentTarget.dataset.id;
            if (!sessionId) {
                showMessage("Errore", "ID sessione non trovato.");
                return;
            }

            showLoader();
            modalSessionTitleEl.textContent = `Esercizi della Sessione`;
            pastSessionIdInput.value = sessionId;
            addExerciseToPastFormContainer.classList.add('hidden');
            exercisesListEl.classList.remove('hidden');

            try {
                await renderExercisesForSession(sessionId, exercisesListEl, { showEditDelete: true });
                exercisesModal.classList.remove('hidden');
                exercisesModal.classList.add('flex');
            } catch (error) {
                console.error("Errore nel mostrare i dettagli della sessione:", error);
                showMessage("Errore", "Impossibile caricare i dettagli della sessione.");
            } finally {
                hideLoader();
            }
        };

        closeExercisesModalBtn.addEventListener('click', () => {
            exercisesModal.classList.remove('flex');
            exercisesModal.classList.add('hidden');
        });
        closeEditModalBtn.addEventListener('click', () => {
            editModal.classList.remove('flex');
            editModal.classList.add('hidden');
        });

        const handleEdit = async (e) => {
            const sessionId = e.target.dataset.sessionId;
            const exerciseId = e.target.dataset.exerciseId;
            if (!sessionId || !exerciseId) return;

            showLoader();
            editSets.length = 0;
            editSetsList.innerHTML = '';
            editVolumeInput.value = '';

            try {
                const exerciseDoc = await getDoc(doc(db, exercisesCollectionPath(userId, sessionId), exerciseId));
                if (exerciseDoc.exists()) {
                    const exerciseData = exerciseDoc.data();
                    editSessionIdInput.value = sessionId;
                    editExerciseIdInput.value = exerciseId;
                    editExerciseInput.value = exerciseData.exercise;
                    editMuscleGroupInput.value = exerciseData.muscleGroup || '';
                    editNotesInput.value = exerciseData.notes || '';
                    
                    if (exerciseData.sets && Array.isArray(exerciseData.sets)) {
                        // Create new plain objects to avoid issues with immutable Firestore data
                        exerciseData.sets.forEach(set => editSets.push({ weight: set.weight, reps: set.reps }));
                    }
                    renderSetsList(editSets, editSetsList, editWeightInput, editRepsInput, editVolumeInput);
                    
                    editModal.classList.remove('hidden');
                    editModal.classList.add('flex');
                } else {
                    showMessage("Errore", "Esercizio non trovato.");
                }
            } catch (error) {
                console.error("Errore nel caricare i dati per la modifica:", error);
                showMessage("Errore", "Impossibile caricare i dati.");
            } finally {
                hideLoader();
            }
        };

        editWorkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sessionId = editSessionIdInput.value;
            const exerciseId = editExerciseIdInput.value;
            if (!sessionId || !exerciseId) {
                showMessage("Errore", "Dati allenamento non validi per la modifica.");
                return;
            }

            const totalVolume = editSets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
            
            if (editSets.length === 0) {
                 showMessage("Errore", "Per favor, aggiungi almeno una serie.");
                 return;
            }

            const updatedExercise = {
                exercise: editExerciseInput.value.trim(),
                muscleGroup: editMuscleGroupInput.value,
                sets: editSets,
                volume: totalVolume,
                notes: editNotesInput.value.trim(),
            };

            showLoader();
            try {
                // Re-fetch the original document to preserve the timestamp
                const originalDocRef = doc(db, exercisesCollectionPath(userId, sessionId), exerciseId);
                const originalDoc = await getDoc(originalDocRef);
                if (originalDoc.exists() && originalDoc.data().timestamp) {
                    updatedExercise.timestamp = originalDoc.data().timestamp;
                } else {
                    // Fallback to server timestamp if original is missing for some reason
                    updatedExercise.timestamp = serverTimestamp();
                }

                await updateDoc(doc(db, exercisesCollectionPath(userId, sessionId), exerciseId), updatedExercise);

                // Transactionally update muscle groups for the session
                await runTransaction(db, async (transaction) => {
                    const sessionRef = doc(db, sessionsCollectionPath(userId), sessionId);
                    const exercisesSnapshot = await getDocs(query(collection(db, exercisesCollectionPath(userId, sessionId))));
                    
                    const muscleGroups = new Set();
                    exercisesSnapshot.forEach(exerciseDoc => {
                        const muscleGroup = exerciseDoc.data().muscleGroup;
                        if (muscleGroup) {
                            muscleGroups.add(muscleGroup);
                        }
                    });
                    
                    const sessionDoc = await transaction.get(sessionRef);
                    if (sessionDoc.exists()) {
                        transaction.update(sessionRef, { muscleGroups: Array.from(muscleGroups) });
                    }
                });

                editModal.classList.remove('flex');
                editModal.classList.add('hidden');
                await renderExercisesForSession(sessionId, exercisesListEl, { showEditDelete: true });
                showMessage("Successo", "Esercizio modificato con successo!");
            } catch (error) {
                console.error("Errore durante la modifica dell'esercizio:", error);
                showMessage("Errore", "Si è verificato un errore durante la modifica dell'esercizio.");
            } finally {
                hideLoader();
            }
        });

        const handleDelete = async (e) => {
            const sessionId = e.target.dataset.sessionId;
            const exerciseId = e.target.dataset.exerciseId;
            if (!sessionId || !exerciseId) return;

            showConfirmationModal(
                "Conferma Eliminazione",
                "Sei sicuro di voler eliminare questo esercizio?",
                "Elimina",
                async () => {
                    showLoader();
                    try {
                        await deleteDoc(doc(db, exercisesCollectionPath(userId, sessionId), exerciseId));
                        
                        // Transactionally update muscle groups for the session after deletion
                        await runTransaction(db, async (transaction) => {
                            const sessionRef = doc(db, sessionsCollectionPath(userId), sessionId);
                            const exercisesSnapshot = await getDocs(query(collection(db, exercisesCollectionPath(userId, sessionId))));

                            const muscleGroups = new Set();
                            exercisesSnapshot.forEach(exerciseDoc => {
                                const muscleGroup = exerciseDoc.data().muscleGroup;
                                if (muscleGroup) {
                                    muscleGroups.add(muscleGroup);
                                }
                            });

                            const sessionDoc = await transaction.get(sessionRef);
                            if (sessionDoc.exists()) {
                                transaction.update(sessionRef, { muscleGroups: Array.from(muscleGroups) });
                            }
                        });

                        await renderExercisesForSession(sessionId, exercisesListEl, { showEditDelete: true });
                        showMessage("Eliminato", "Esercizio eliminato con successo.");
                    } catch (error) {
                        console.error("Errore nell'eliminare l'esercizio:", error);
                        showMessage("Errore", "Si è verificato un errore durante l'eliminazione.");
                    } finally {
                        hideLoader();
                    }
                }
            );
        };
        
        const deleteSessionAndAllExercises = async (sessionId) => {
            if (!sessionId) return;
            showLoader();

            try {
                const sessionRef = doc(db, sessionsCollectionPath(userId), sessionId);
                const exercisesCollectionRef = collection(db, exercisesCollectionPath(userId, sessionId));

                // Get all exercise documents to delete them in a batch
                const exercisesSnapshot = await getDocs(exercisesCollectionRef);
                const batch = writeBatch(db);

                exercisesSnapshot.forEach((exerciseDoc) => {
                    batch.delete(exerciseDoc.ref);
                });
                batch.delete(sessionRef);
                await batch.commit();

                exercisesModal.classList.remove('flex');
                exercisesModal.classList.add('hidden');
                showMessage("Eliminato", "L'allenamento è stato eliminato con successo.");
            } catch (error) {
                console.error("Errore nell'eliminare l'allenamento completo:", error);
                showMessage("Errore", "Si è verificato un errore durante l'eliminazione completa dell'allenamento.");
            } finally {
                hideLoader();
            }
        };

        addExerciseToPastBtn.addEventListener('click', () => {
            exercisesListEl.classList.add('hidden');
            addExerciseToPastFormContainer.classList.remove('hidden');
            pastSets = [];
            pastSetsList.innerHTML = '';
            pastVolumeInput.value = '';
            pastWeightInput.value = '';
            pastRepsInput.value = '';
        });

        backToExercisesBtn.addEventListener('click', () => {
            addExerciseToPastFormContainer.classList.add('hidden');
            exercisesListEl.classList.remove('hidden');
        });

        addExerciseToPastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sessionId = pastSessionIdInput.value;
            if (!sessionId || !userId) {
                showMessage("Errore", "Dati sessione non validi.");
                return;
            }

            let exerciseName = pastExerciseSelect.value;
            if (exerciseName === 'new') {
                exerciseName = pastNewExerciseInput.value.trim();
            }
            const muscleGroup = pastMuscleGroupInput.value;
            const notes = pastNotesInput.value.trim();
            const totalVolume = pastSets.reduce((sum, set) => sum + (set.weight * set.reps), 0);

            if (!exerciseName || !muscleGroup || pastSets.length === 0) {
                showMessage("Errore", "Per favor, compila tutti i campi obbligatori e aggiungi almeno una serie.");
                return;
            }

            showLoader();
            try {
                // Fetch the session to get its timestamp, ensuring consistency
                const sessionRef = doc(db, sessionsCollectionPath(userId, sessionId));
                const sessionDoc = await getDoc(sessionRef);
                if (!sessionDoc.exists()) {
                    throw new Error("Session document not found while adding exercise.");
                }
                const sessionTimestamp = sessionDoc.data().timestamp;

                const newExercise = {
                    exercise: exerciseName,
                    muscleGroup,
                    sets: pastSets,
                    volume: totalVolume,
                    notes,
                    timestamp: sessionTimestamp, // Use the session's timestamp
                };

                await addDoc(collection(db, exercisesCollectionPath(userId, sessionId)), newExercise);
                await updateSessionMuscleGroupsInTransaction(sessionId);
                addExerciseToPastForm.reset();
                pastSets = [];
                pastSetsList.innerHTML = '';
                pastVolumeInput.value = '';
                addExerciseToPastFormContainer.classList.add('hidden');
                exercisesListEl.classList.remove('hidden');
                await renderExercisesForSession(sessionId, exercisesListEl, { showEditDelete: true });
                showMessage("Successo", "Esercizio aggiunto alla sessione passata!");
            } catch (error) {
                console.error("Errore nell'aggiungere l'esercizio a una sessione passata:", error);
                showMessage("Errore", "Si è verificato un errore durante il salvataggio dell'esercizio.");
            } finally {
                hideLoader();
            }
        });

        addPastSessionBtn.addEventListener('click', () => {
            newPastSessionId = null;
            newPastExerciseForm.reset();
            newPastSets = [];
            newPastSetsList.innerHTML = '';
            newPastVolumeInput.value = '';
            newPastSessionInfo.textContent = 'Seleziona una data e ora e aggiungi il primo esercizio.';
            newPastWorkoutDatetime.disabled = false;
            
            document.getElementById('new-past-exercises-list').innerHTML = '<p class="text-center text-gray-400">Nessun esercizio ancora aggiunto.</p>';
            
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            newPastWorkoutDatetime.value = now.toISOString().slice(0,16);

            showView('new-past-workout-view');
        });

        homeHistoryBtn.addEventListener('click', () => {
            showView('history-view');
            loadHistory();
        });
        historyBackBtn.addEventListener('click', () => {
            showView('home-view');
        });
        
        homeLogoutBtn.addEventListener('click', async () => {
            showLoader();
            try {
                await signOut(auth);
                showMessage("Logout", "Sei stato disconnesso con successo.");
                showView('auth-view');
            } catch (error) {
                console.error("Errore durante il logout:", error);
                showMessage("Errore", "Si è verificato un problema durante il logout.");
            } finally {
                hideLoader();
            }
        });

        authAnonBtn.addEventListener('click', async () => {
            showLoader();
            try {
                await signInAnonymously(auth);
                showMessage("Benvenuto", "Accedi in modalità anonima. I tuoi dati saranno salvati su questo dispositivo.");
            } catch (error) {
                console.error("Errore durante l'accesso anonimo:", error);
                showMessage("Errore", "Si è verificato un problema durante l'accesso anonimo.");
            } finally {
                hideLoader();
            }
        });

        authRegisterBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
             if (!email.includes('@') || !email.includes('.')) {
                showMessage("Errore", "L'email deve essere in un formato valido.");
                return;
            }
             if (password.length < 6) {
                showMessage("Errore", "La password deve contenere almeno 6 caratteri.");
                return;
            }
            showLoader();
            try {
                 await createUserWithEmailAndPassword(auth, email, password);
                 showMessage("Registrazione", "Registrazione completata con successo! Ora puoi accedere.");
            } catch (error) {
                console.error("Errore durante la registrazione:", error);
                showMessage("Errore", "Si è verificato un errore durante la registrazione. Riprova con un'altra email o password.");
            } finally {
                hideLoader();
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            if (!email.includes('@') || !email.includes('.')) {
                showMessage("Errore", "L'email deve essere in un formato valido.");
                return;
            }
            if (password.length < 6) {
                showMessage("Errore", "La password deve contenere almeno 6 caratteri.");
                return;
            }
            showLoader();
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Accesso", "Accesso completato con successo!");
            } catch (error) {
                console.error("Errore durante l'accesso:", error);
                showMessage("Errore", "Errore durante l'accesso. Controlla email e password e riprova.");
            } finally {
                hideLoader();
            }
        });
        
        deleteSessionBtn.addEventListener('click', () => {
            const sessionId = pastSessionIdInput.value;
            showConfirmationModal(
                "Conferma Eliminazione",
                "Sei sicuro di voler eliminare questo allenamento? Questa azione non può essere annullata.",
                "Elimina",
                () => deleteSessionAndAllExercises(sessionId)
            );
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (typeof confirmAction === 'function') {
                confirmAction();
            }
            hideConfirmModal();
        });

        cancelDeleteBtn.addEventListener('click', hideConfirmModal);
        closeConfirmModalBtn.addEventListener('click', hideConfirmModal);

        togglePasswordBtn.addEventListener('click', () => {
            const type = authPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            authPasswordInput.setAttribute('type', type);
            eyeIcon.classList.toggle('hidden');
            eyeOffIcon.classList.toggle('hidden');
        });

        homeRecordsBtn.addEventListener('click', () => {
            showView('records-view');
            recordsChoiceView.classList.remove('hidden');
            recordsDisplayView.classList.add('hidden');
        });

        recordsBackBtn.addEventListener('click', () => {
            showView('home-view');
        });

        recordsDisplayBackBtn.addEventListener('click', () => {
            recordsDisplayView.classList.add('hidden');
            recordsChoiceView.classList.remove('hidden');
        });

        recordsMaxWeightBtn.addEventListener('click', () => {
            recordsChoiceView.classList.add('hidden');
            recordsDisplayView.classList.remove('hidden');
            recordsDisplayTitle.textContent = 'Massimale per singola serie';
            loadMaxWeightRecords();
        });

        recordsTotalVolumeExerciseBtn.addEventListener('click', () => {
            recordsChoiceView.classList.add('hidden');
            recordsDisplayView.classList.remove('hidden');
            recordsDisplayTitle.textContent = 'Volume Totale per Esercizio';
            loadTotalVolumeExerciseRecords();
        });

        recordsTotalVolumeMuscleGroupBtn.addEventListener('click', () => {
            recordsChoiceView.classList.add('hidden');
            recordsDisplayView.classList.remove('hidden');
            recordsDisplayTitle.textContent = 'Volume Totale per Gruppo Muscolare';
            loadTotalVolumeMuscleGroupRecords();
        });
    </script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
</body>
</html>
